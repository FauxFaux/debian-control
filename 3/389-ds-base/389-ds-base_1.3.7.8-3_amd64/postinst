#!/bin/sh
set -e

. /usr/share/debconf/confmodule

CONFIG_DIR=/etc/dirsrv
OUT=/dev/null
INSTANCES=`ls -d /etc/dirsrv/slapd-* 2>/dev/null | grep -v removed | sed 's/.*slapd-//'`

if [ "$1" = configure ]; then
    # lets give them a user/group in all cases.
    if ! getent passwd dirsrv > $OUT; then
	adduser --quiet --system --home /var/lib/dirsrv \
	    --disabled-password --group \
	    --gecos "389 Directory Server user" \
	    --no-create-home \
	    dirsrv > $OUT
    fi

    chown -R dirsrv:dirsrv /etc/dirsrv/ /var/log/dirsrv/ /var/lib/dirsrv/ > $OUT || true
    chmod 750 /etc/dirsrv/ /var/log/dirsrv/ /var/lib/dirsrv/ > $OUT || true

    if [ -n "$2" ]; then
        for inst in $INSTANCES; do
            service dirsrv@$inst stop > $OUT 2>&1
        done

        setup-ds -l $OUT -u -s General.UpdateMode=offline > $OUT 2>&1

        if [ $? = 0 ]; then
            for inst in $INSTANCES; do
                service dirsrv@$inst start > $OUT 2>&1
            done
        fi
    fi
fi

invoke_failure() {
    # invoke-rc.d failed, likely because no instance has been configured yet
    # but exit with an error if an instance is configured and the invoke failed
    if [ -z $INSTANCES ]; then
        echo "... because no instance has been configured yet."
    else
	exit 1
    fi
}


# Automatically added by dh_systemd_enable/11
if deb-systemd-helper debian-installed 'dirsrv-snmp.service'; then
	# This will only remove masks created by d-s-h on package removal.
	deb-systemd-helper unmask 'dirsrv-snmp.service' >/dev/null || true

	if deb-systemd-helper --quiet was-enabled 'dirsrv-snmp.service'; then
		# Create new symlinks, if any.
		deb-systemd-helper enable 'dirsrv-snmp.service' >/dev/null || true
	fi
fi

# Update the statefile to add new symlinks (if any), which need to be cleaned
# up on purge. Also remove old symlinks.
deb-systemd-helper update-state 'dirsrv-snmp.service' >/dev/null || true
# End automatically added section
# Automatically added by dh_systemd_start/11
if [ -d /run/systemd/system ]; then
	systemctl --system daemon-reload >/dev/null || true
	deb-systemd-invoke start 'dirsrv-snmp.service' 'dirsrv.target' >/dev/null || true
fi
# End automatically added section

