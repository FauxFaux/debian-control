#!/bin/bash
set -e

. /usr/share/debconf/confmodule

export PATH=$PATH:/sbin:/usr/sbin:/bin:/usr/bin

TEMPLATE=/usr/share/chef/client.rb
CONFIGFILE=/etc/chef/client.rb

case "$1" in
  configure|reconfigure)
    db_get chef/chef_server_url && server_url="$RET"
    TMPFILE=`mktemp`
    if [ -n "$server_url" ]; then
      sed "s#chef_server_url \".*\"#chef_server_url \"$server_url\"#" $TEMPLATE > $TMPFILE
    fi
    ucf --debconf-ok $TMPFILE $CONFIGFILE
    test -f $CONFIGFILE && chmod 0640 $CONFIGFILE
    # Workaround configuration conflict w/ checksum cache and client cleanup
    mkdir -p /var/lib/chef/cookbook_index
    find /var/cache/chef/checksums/ -depth -mindepth 1 -type d -exec mv {} /var/lib/chef/cookbook_index \;
  ;;

  abort-upgrade|abort-remove|abort-deconfigure)
  ;;

  *)
    echo "postinst called with unknown argument \`$1'" >&2
    exit 1
  ;;
esac

db_stop

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

# Automatically added by dh_installinit/10.7.2
if [ "$1" = "configure" ] || [ "$1" = "abort-upgrade" ]; then
	if [ -x "/etc/init.d/chef-client" ]; then
		update-rc.d chef-client defaults 99 02 >/dev/null
		invoke-rc.d chef-client start || exit $?
	fi
fi
# End automatically added section


exit 0
