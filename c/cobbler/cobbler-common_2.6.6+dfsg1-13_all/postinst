#!/bin/sh

set -e

pkgos_adduser () {
	local VAR_UG_PKG_NAME
	VAR_UG_PKG_NAME=${1}

	# Create user and groups if they don't exist
	if ! getent group ${VAR_UG_PKG_NAME} > /dev/null 2>&1 ; then
		addgroup --quiet --system ${VAR_UG_PKG_NAME}
	fi
	if ! getent passwd ${VAR_UG_PKG_NAME} > /dev/null 2>&1 ; then
		adduser --system \
			--home /var/lib/${VAR_UG_PKG_NAME} \
			--no-create-home \
			--quiet \
			--disabled-password \
			--shell /bin/bash \
			--group ${VAR_UG_PKG_NAME}
	fi
}

pkgos_var_user_group () {
	local VAR_UG_PKG_NAME
	VAR_UG_PKG_NAME=${1}

	pkgos_adduser ${VAR_UG_PKG_NAME}

	# Create /var/{lib,log}/<package> with that user/group if it doesn't exist
	if [ ! -d /var/lib/${VAR_UG_PKG_NAME} ] ; then
		mkdir -p /var/lib/${VAR_UG_PKG_NAME}/cache
	fi
	chown ${VAR_UG_PKG_NAME}:${VAR_UG_PKG_NAME} /var/lib/${VAR_UG_PKG_NAME}
	chmod 0755 /var/lib/${VAR_UG_PKG_NAME}
	if [ ! -d /var/log/${VAR_UG_PKG_NAME} ] ; then
		mkdir -p /var/log/${VAR_UG_PKG_NAME}
	fi
	chown ${VAR_UG_PKG_NAME}:${VAR_UG_PKG_NAME} /var/log/${VAR_UG_PKG_NAME}
	chmod 0750 /var/log/${VAR_UG_PKG_NAME}
}


if [ "$1" = "configure" ] ; then
	pkgos_var_user_group cobbler
	for i in users.digest settings ; do
		if ! [ -e /etc/cobbler/$i ] ; then
			touch /etc/cobbler/$i
			chown cobbler:cobbler /etc/cobbler/$i
			chmod 660 /etc/cobbler/$i
			cat /usr/share/cobbler-common/debian-package-etc-templates/$i >/etc/cobbler/$i
		fi
	done
fi



exit 0
