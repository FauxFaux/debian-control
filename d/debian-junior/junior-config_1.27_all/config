#!/bin/sh -e

# Initialize debconf if not yet done
if [ _"$DEBCONF_REDIR" = _"" ]; then
    . /usr/share/debconf/confmodule
    db_version 2.0
    db_capb backup
fi

db_input "medium" "shared/junior-config/useusermenus" || true
db_go
db_get shared/junior-config/useusermenus
if [ $RET ] ; then
    db_input "medium" "shared/junior-config/usermenus" || true
    db_go
fi

# if blends.config package is not yet installed we have to stop here
if [ ! -f /etc/blends/blends.conf ] ; then
   db_stop
   exit 0
fi

[ -s /etc/blends/blends.conf ]         && . /etc/blends/blends.conf
[ -s /etc/blends/junior/junior.conf ] && . /etc/blends/junior/junior.conf

# Add at least one default role for each Blend
addRole junior junior

# Login names of all users of the system as comma separated list 
USERS=`getAllUsers 0 ,`

# "login (Real Name)" of users registered to the Debian Pure Blend junior
BLENDUSERS=`getUsersInRole junior junior 0 ,`

db_set junior-config/group "$BLENDUSERS"
db_subst junior-config/group users "$USERS"
db_get junior-config/group

db_input high junior-config/group || true
db_go

db_stop

if [ -d /etc/blends/junior/ ] ; then 
    if [ ! -f /etc/blends/junior/junior.conf ] ; then 
        # Due to a bug in blends-common the real Blend config file was moved to junior.conf~.  This is fixed here
        if [ -f /etc/blends/junior/junior.conf~ ] ; then
            cp -a /etc/blends/junior/junior.conf~ /etc/blends/junior/junior.conf
        fi
    fi
fi
                
exit 0
