#!/bin/sh
#
# stolen from ttf-dejavu/debian/ttf-dejavu-core.preinst :)
# 

set -e

PKG="ttf-vlgothic"
PKG_VERSION="20091202-1"
PKG_VERSION_2="20110722-3"

FONTCONF_FILE=64-ttf-vlgothic.conf

OLD_ALT_NAME="ttf-japanese-gothic"
FONT_ENTRY="/usr/share/fonts/truetype/fonts-vlgothic/VL-Gothic-Regular.ttf"

CHECK_VERSION="20110722-4"


rm_conffile() {
  PKGNAME="$1"
  CONFFILE="$2"
  if [ -e "$CONFFILE" ]; then
   md5sum="`md5sum \"$CONFFILE\" | sed -e \"s/ .*//\"`"
   old_md5sum="`dpkg-query -W -f='${Conffiles}' $PKGNAME | sed -n -e \"\\\\' $CONFFILE'{s/ obsolete$//;s/.* //p}\"`"
   if [ "$md5sum" != "$old_md5sum" ]; then
     echo "Obsolete conffile $CONFFILE has been modified by you."
     echo "Saving as $CONFFILE.dpkg-bak ..."
     mv -f "$CONFFILE" "$CONFFILE".dpkg-bak
   else
     echo "Removing obsolete conffile $CONFFILE ..."
     rm -f "$CONFFILE"
   fi
 fi
}

pathfind() {
    OLDIFS="$IFS"
    IFS=:
    for p in $PATH; do
        if [ -x "$p/$*" ]; then
            IFS="$OLDIFS"
            return 0
        fi
    done
    IFS="$OLDIFS"
    return 1
}


case "$1" in
install|upgrade)
  if dpkg --compare-versions "$2" lt-nl "$PKG_VERSION"; then
      FILE="/etc/defoma/hints/${PKG}.hints"
      if [ -f $FILE ]; then
          if `pathfind defoma-font`; then
	      defoma-font purge-all $FILE || true
	  fi
      fi
      rm_conffile $PKG $FILE
  fi

  # if old conffile exists, then remove it.
  if [ -f /etc/fonts/conf.d/${FONTCONF_FILE} ]; then
      rm /etc/fonts/conf.d/${FONTCONF_FILE}
  fi

  # * remove not ".ttf" postfix file
  if [ -f /usr/share/fonts/truetype/$OLD_ALT_NAME ]; then
      rm /usr/share/fonts/truetype/$OLD_ALT_NAME
  fi


# eliminate update-alternatives warning
  if dpkg --compare-versions "$2" lt-nl "$PKG_VERSION_2"; then
      DIR="/usr/share/fonts/truetype/fonts-vlgothic"
      if [ -d $DIR ]; then
          update-alternatives --remove $OLD_ALT_NAME.ttf $FONT_ENTRY
      fi
  fi


  if dpkg --compare-versions "$2" lt-nl "$CHECK_VERSION"; then
          update-alternatives --remove $OLD_ALT_NAME.ttf /usr/share/fonts/truetype/vlgothic/VL-Gothic-Regular.ttf
  fi

	# Remove the alternative set up by the old ttf-vlgothic package.
	# Do this again here since there is no guarantee that the transitional
	# ttf-vlgothic package was installed and has cleaned this up.
	# Do this for new installations (as we can't distinguish them from
	# "upgrades" from ttf-vlgothic) as well as upgrades that did not yet
	# clean this up.
	# (This can be removed after jessie was released with this code.)
	if dpkg --compare-versions "$2" lt "20121230-1.1~" ; then
		update-alternatives --remove ttf-japanese-gothic.ttf \
			/usr/share/fonts/truetype/vlgothic/VL-Gothic-Regular.ttf
	fi

esac


exit 0
