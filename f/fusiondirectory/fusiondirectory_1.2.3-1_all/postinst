#!/bin/sh
# postinst script for fusiondirectory
#
# see: dh_installdeb(1)

set -e

# Source debconf library.
. /usr/share/debconf/confmodule

case "$1" in
  configure)
      fusiondirectory-setup -y --check-directories --update-cache --update-locales
      ;;

  abort-upgrade|abort-remove|abort-deconfigure)
      ;;

  triggered)
      fusiondirectory-setup --update-cache --update-locales
      exit 0
      ;;

  *)
      echo "postinst called with unknown argument \`$1'" >&2
      exit 1
      ;;
esac



# Apache2.2 / drop fusiondirectory.conf from deprecated conf.d
if [ -d /etc/apache2/conf.d ]; then

        # Remove FD configuration from conf.d directories, if that still exists...
        if   [ -L /etc/apache2/conf.d/fusiondirectory.conf ]; then
                rm /etc/apache2/conf.d/fusiondirectory.conf
        elif [ -f /etc/apache2/conf.d/fusiondirectory.conf ]; then
                mv /etc/apache2/conf.d/fusiondirectory.conf /etc/apache2/conf.d/fusiondirectory.conf.obsolete
        fi

fi

# conf-available
if [ -d /etc/apache2/conf-available ] ; then

  # Copy FusionDirectory configuration to conf-available directory /etc/apache2/conf-available
  if [ ! -L /etc/apache2/conf-available/fusiondirectory.conf ]; then

    # Remove old instances of this file
    if [ -f /etc/apache2/conf-available/fusiondirectory.conf ]; then
      echo "Found old fusiondirectory apache configuration in /etc/apache2/conf-available - moving it to fusiondirectory.conf.orig..."
      echo "Please check for changes in /etc/fusiondirectory/fusiondirectory-apache.conf if you modified this file!"
      mv /etc/apache2/conf-available/fusiondirectory.conf /etc/apache2/conf-available/fusiondirectory.conf.orig
    fi

    echo "Making /fusiondirectory available in /etc/apache2/conf-available"

    # Add FusionDirectory include file
    ln -s /etc/fusiondirectory/fusiondirectory-apache.conf /etc/apache2/conf-available/fusiondirectory.conf
  fi

  if [ -e /usr/share/apache2/apache2-maintscript-helper ] ; then
    . /usr/share/apache2/apache2-maintscript-helper
    apache2_invoke enconf fusiondirectory
    apache2_invoke enconf javascript-common
    apache2_invoke enmod headers
  fi

  # Finally restart servers
  if [ -x "$(which apache2ctl)" ]; then
    if [ -x "$(which invoke-rc.d)" ]; then
      invoke-rc.d apache2 reload
    else
      /etc/init.d/apache2 reload
    fi
  fi
fi

# Remove old instances of the fusiondirectory.conf template
if [ -f /var/cache/fusiondirectory/template/fusiondirectory.conf ]; then
  #link the template to /var/cache/fusiondirectory/template from usr
  rm -f /var/cache/fusiondirectory/template/fusiondirectory.conf
  ln -s /usr/share/doc/fusiondirectory/fusiondirectory.conf  /var/cache/fusiondirectory/template/fusiondirectory.conf
else
  #link the configuration template to /var/cache/fusiondirectory/template from /usr/share/doc/fusiondirectory/
  ln -s /usr/share/doc/fusiondirectory/fusiondirectory.conf  /var/cache/fusiondirectory/template/fusiondirectory.conf
fi

exit 0
