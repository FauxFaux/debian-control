#!/bin/sh
# preinst script for geoip-database-contrib

set -e

# summary of how this script can be called:
#        * <new-preinst> `install'
#        * <new-preinst> `install' <old-version>
#        * <new-preinst> `upgrade' <old-version>
#        * <old-preinst> `abort-upgrade' <new-version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    upgrade)
        if dpkg --compare-versions "$2" ge "1.4~" && \
           dpkg --compare-versions "$2" lt "1.5~"; then
            # We are upgrading from the version which renamed GeoLiteCity.dat
            # to GeoIPCity.dat
            if [ -f /usr/share/GeoIP/GeoIPCity.dat ]; then
                # We have a GeoIPCity.dat which is a regular file. It is
                # probably the GeoLiteCity.dat file downloaded from GeoIP.
                # In any case, rename it so it will accessible via the
                # update-alternatives symlink created in the postinst script.
                echo "Renaming /usr/share/GeoIP/GeoIPCity.dat to GeoLiteCity.dat";
                mv /usr/share/GeoIP/GeoIPCity.dat \
                   /usr/share/GeoIP/GeoLiteCity.dat
            fi
        fi
        if dpkg --compare-versions "$2" lt "1.17~"; then
            # Files have been moved to /var/lib/geoip-database-contrib in
            # version 1.17.
            for f in GeoIP.dat GeoIPASNum.dat GeoIPASNumv6.dat GeoIPv6.dat \
                     GeoLiteCity.dat GeoLiteCityv6.dat; do
                if [ -f /usr/share/GeoIP/$f -a \
                     ! -h /usr/share/GeoIP/$f ]; then
                    echo "Moving /usr/share/GeoIP/$f to /var/lib/geoip-database-contrib";
                    mkdir -p /var/lib/geoip-database-contrib
                    mv /usr/share/GeoIP/$f \
                       /var/lib/geoip-database-contrib/$f
                fi
            done
        fi
    ;;

    install|abort-upgrade)
    ;;

    *)
        echo "preinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.



exit 0
