#!/bin/sh
# postinst script for gridengine-master
#
# see: dh_installdeb(1)

set -e

# Source debconf library
. /usr/share/debconf/confmodule

sgeroot=/var/lib/gridengine
sgespool=/var/spool/gridengine
user=sgeadmin

case "$1" in
  configure)

    # Setup directories on a new install
    if [ -z "$2" ]; then
      for d in ${sgespool}/qmaster \
               ${sgespool}/qmaster/job_scripts \
               ${sgespool}/spooldb
      do
          mkdir -p ${d}
          chown ${user}:${user} ${d}
          chmod 755 ${d}
      done

      # Check that we're meant to install a cluster
      db_get shared/gridengineconfig || true

      if [ "${RET}" = "true" ]; then
          db_get shared/gridenginecell || true
          SGE_CELL="${RET}"
          if [ -z "${SGE_CELL}" ]; then
              SGE_CELL=default
          fi

          # Initialize a default cluster
          su -s /bin/sh -c "/usr/share/gridengine/scripts/init_cluster ${sgeroot} ${SGE_CELL} ${sgespool}/spooldb ${user}" ${user}
      fi
    fi
  ;;
  *)
    echo "postinst called with unknown argument \`$1'" >&2
    exit 1
  ;;
esac

db_stop || true

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

# Automatically added by dh_installinit
if [ "$1" = "configure" ] || [ "$1" = "abort-upgrade" ]; then
	if [ -x "/etc/init.d/gridengine-master" ]; then
		update-rc.d gridengine-master defaults >/dev/null
		if [ -n "$2" ]; then
			_dh_action=restart
		else
			_dh_action=start
		fi
		invoke-rc.d gridengine-master $_dh_action || exit $?
	fi
fi
# End automatically added section


exit 0
