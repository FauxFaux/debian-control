#! /bin/sh
# preinst script for hyperestraier
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <new-preinst> `install'
#        * <new-preinst> `install' <old-version>
#        * <new-preinst> `upgrade' <old-version>
#        * <old-preinst> `abort-upgrade' <new-version>
#
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    install|upgrade)
    if test -f /etc/default/hyperestraier; then
	. /etc/default/hyperestraier
    fi
    if dpkg --compare-versions "$2" lt 1.3.3 && test -d $ROOTDIR/_node; then
	# db incompatible
	[ -d /var/lib/hyperestraier ] || mkdir -p /var/lib/hyperestraier 
	cp -p /usr/bin/estcmd /var/lib/hyperestraier/estcmd.$2
	# stop node server to access db directory
	if [ -x "`which invoke-rc.d 2>/dev/null`" ]; then
	    invoke-rc.d hyperestraier stop || true
	else
	    /etc/init.d/hyperestraier stop || true
	fi
	echo -n "node database dumping..."
	rm -rf $ROOTDIR.dpkg-tmp
	mkdir -p $ROOTDIR.dpkg-tmp/_node
	echo "$2" > $ROOTDIR.dpkg-tmp/_pkg_version
	# XXX:
	# estcmd search -dd -max -1 casket [UVSET]
	for nodedir in $ROOTDIR/_node/*
	do
	  test -d $nodedir || continue
	  nodename=$(basename $nodedir)
	  echo -n " node/$nodename"
	  nodetmp=$ROOTDIR.dpkg-tmp/_node/$nodename
	  mkdir -p $nodetmp
	  estcmd list $nodedir | while read id uri
	  do
	    estcmd get $nodedir $id > $nodetmp/$id.est
	  done
	done
	echo " done."
    fi
    ;;

    abort-upgrade)
    ;;

    *)
        echo "preinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.



exit 0


