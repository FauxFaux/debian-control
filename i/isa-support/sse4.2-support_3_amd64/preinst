#!/bin/bash
#dash is fine, too, but not general /bin/sh (ulimit)
set -e

if [ "$1" = install -o "$1" = upgrade ]; then
    # Writing to /usr/lib is nasty but some folks mount everything noexec.
    FILE=`mktemp /usr/lib/sse4.2-support.XXXXXXXXXX`
    trap "rm -f '$FILE'" EXIT
    perl <<'END' |gzip -cdf >"$FILE"
binmode STDOUT;
print unpack "u*", <<'end';
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
=I?EY+#Q^_T_7EBF>*V["OSO-_O=?.:8XR_@G````
`
end

END
    chmod u+x "$FILE"
    # "exec >;command" instead of "command >" looks strange but regular
    # redirections don't fully work within qemu-user.
    ret=0;(ulimit -c 0; exec >/dev/null 2>&1; "$FILE") || ret=$?
    rm -f "$FILE"
    trap - EXIT

    if [ $ret -ne 0 -a -n "$IGNORE_ISA" ]; then
        cat >&2 <<END
This machine doesn't support sse4.2, but override (IGNORE_ISA) is enabled.
Continuing...
END
	ret=0
    fi

    if [ $ret -eq 126 ]; then
        cat >&2 <<END
Couldn't execute test binary for sse4.2, you either do foreign multi-arch
without qemu or do something strange.  Assuming you know what you're doing.
Continuing...
END
	ret=0
    fi

    if [ $ret -ne 0 ]; then
        # Fail noisily, first via debconf (if installed).
        if [ -e /usr/share/debconf/confmodule ]; then

            . /usr/share/debconf/confmodule
            db_version 2.0

            db_fset sse4.2-support/fail seen false ||:
            db_reset sse4.2-support/fail ||:
            db_input critical sse4.2-support/fail ||:
            db_go ||:
            db_stop ||:
        fi

        cat >&2 <<END
This machine doesn't support sse4.2, sorry.
Aborting.
END
        exit 2
    fi
fi



exit 0
