#!/bin/sh

set -e

if [ "${1}" = "configure" ] || [ "${1}" = "reconfigure" ]; then
	VAR_UG_PKG_NAME=ivulncheck
	# Create user and groups if they don't exist
	if ! getent group ${VAR_UG_PKG_NAME} > /dev/null 2>&1 ; then
		addgroup --quiet --system ${VAR_UG_PKG_NAME}
	fi
	if ! getent passwd ${VAR_UG_PKG_NAME} > /dev/null 2>&1 ; then
		adduser --system \
		       --home /var/lib/${VAR_UG_PKG_NAME}-api \
		       --no-create-home \
		       --quiet \
		       --disabled-password \
		       --shell /bin/false \
		       --group ${VAR_UG_PKG_NAME}
	fi

	install -d -m 0750 -o ivulncheck -g ivulncheck /var/lib/ivulncheck-api/debsecan || true
	install -d -m 0750 -o ivulncheck -g ivulncheck /var/lib/ivulncheck-api/fake-repos || true
        install -d -m 0750 -o ivulncheck -g ivulncheck /var/lib/ivulncheck-api/ubuntu-cve-tracker || true
	install -d -m 0750 -o ivulncheck -g ivulncheck /var/lib/ivulncheck-api/.madison-lite || true
	install -d -m 0750 -o ivulncheck -g ivulncheck /var/lib/ivulncheck-api/.madison-lite/cache || true
	
	if getent group adm >/dev/null 2>&1 ; then
		install -d -m 0750 -o ivulncheck -g adm /var/log/ivulncheck || true
	else
		install -d -m 0750 -o ivulncheck -g root /var/log/ivulncheck || true
	fi
	
	a2enmod wsgi || true
	a2ensite ivulncheck_api.conf || true

	touch /etc/ivulncheck/htpasswd_api || true
	
	if getent group www-data >/dev/null 2>&1 ; then
		chmod 640 /etc/ivulncheck/htpasswd_api || true
		chown root:www-data /etc/ivulncheck/htpasswd_api || true
	else
		chmod 644 /etc/ivulncheck/htpasswd_api || true
	fi

fi


# Automatically added by dh_python3:
if which py3compile >/dev/null 2>&1; then
	py3compile -p ivulncheck-api 
fi
if which pypy3compile >/dev/null 2>&1; then
	pypy3compile -p ivulncheck-api  || true
fi

if which py3compile >/dev/null 2>&1; then
	py3compile -p ivulncheck-api /usr/share/ivulncheck-api
fi
if which pypy3compile >/dev/null 2>&1; then
	pypy3compile -p ivulncheck-api /usr/share/ivulncheck-api || true
fi

# End automatically added section

# Automatically added by dh_python3:
if which py3compile >/dev/null 2>&1; then
	py3compile -p ivulncheck-api /usr/share
fi
if which pypy3compile >/dev/null 2>&1; then
	pypy3compile -p ivulncheck-api /usr/share || true
fi

# End automatically added section


exit 0

