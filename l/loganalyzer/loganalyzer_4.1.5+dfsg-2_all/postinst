#!/bin/sh

# currently comment out because otherwise it freezes
#. /usr/share/debconf/confmodule

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

if [ "$1" = "configure" ];
then

    # To use the web-based config, the admin needs to
    # make this file writeable by www-data - but we don't
    # do that here for the moment.
    #chown www-data /etc/loganalyzer/config.php
    #chmod 0660 /etc/loganalyzer/config.php

    webserver="apache2"
    pkgname=loganalyzer

    if [ -x /usr/sbin/$webserver ];
    then
                # Auto-configure module dependencies
        a2enmod php7.0 || true
        a2enmod php5 || true
        a2enmod cgi || true

        # this is not mandatory, so we don't do it now
        # maybe support this with debconf one day
        #a2enmod mongo || true

        HTTPD_ETC=/etc/$webserver
        HTTPD_CONF_OLD=$HTTPD_ETC/conf.d
        HTTPD_CONF_NEW=$HTTPD_ETC/conf-available
        if [ -d $HTTPD_ETC ];
        then
            if [ -d ${HTTPD_CONF_OLD} -a ! -f ${HTTPD_CONF_OLD}/${pkgname} -a ! -h ${HTTPD_CONF_OLD}/${pkgname} ];
            then
                ln -s /etc/${pkgname}/apache.conf ${HTTPD_CONF_OLD}/${pkgname}
            fi
            if [ -d ${HTTPD_CONF_NEW} -a ! -f ${HTTPD_CONF_NEW}/${pkgname}.conf -a ! -h ${HTTPD_CONF_NEW}/${pkgname}.conf ];
            then
                ln -s /etc/${pkgname}/apache.conf ${HTTPD_CONF_NEW}/${pkgname}.conf
                if [ -e /usr/share/apache2/apache2-maintscript-helper ] ; then
                    . /usr/share/apache2/apache2-maintscript-helper
                    apache2_invoke enconf loganalyzer.conf || exit $?
                fi
            fi
        fi
    fi
fi

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.



exit 0

