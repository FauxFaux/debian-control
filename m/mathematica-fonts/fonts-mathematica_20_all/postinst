#!/bin/sh
# postinst script for fonts-mathematica
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


if [ $1 = configure ]; then

. /usr/share/debconf/confmodule

SHA512SUM=/usr/bin/sha512sum
PDIR=/usr/share/mathematica-fonts
FONTDIR=/usr/share/fonts/truetype/mathematica

do_download=1
do_settings=1
fl_success=0

# check if fonts are already installed
if $SHA512SUM -c --status $PDIR/sha512-ttf 2>/dev/null; then
    do_download=0
fi

if [ $do_download -eq 0 ]; then
    echo "All fonts already exist so not downloading any fonts."
elif [ $do_download -eq 1 ]; then

# start download
db_get mathematica-fonts/http_proxy || true
http_proxy=$RET
export http_proxy

SHA512TGZ=$PDIR/sha512-tgz

URL="http://support.wolfram.com/kb/data/uploads/2014/08/"
FILE="TrueType.zip"

SCRATCHDIR=`mktemp -p /tmp -d mathematica.XXXXXX`
chmod 0755 $SCRATCHDIR
cd $SCRATCHDIR

   if [ -n "$QUIET_MODE" ] ; then
       QUIET_ARG="--quiet"
   else
       QUIET_ARG=""
   fi

HOME=`mktemp -p /tmp -d home.XXXXXX`
export HOME

   if ! wget --continue --tries=1 --dns-timeout=10 --connect-timeout=5 --read-timeout=300 $QUIET_ARG --directory-prefix . --no-directories --no-background $URL$FILE ; then
       echo "Download seems to fail."
   fi

# check downloaded file
echo checking $FILE
   if [ ! -f $FILE ] || ! $SHA512SUM -c --status $SHA512TGZ; then
       echo "Downloaded file looks corrupted!"
       echo "The fonts might be removed on the Web and if so we can do nothing, sorry."
       echo ""
       do_settings=0
   else
       echo "Downloaded successfully."
       echo ""
   fi

# purge type1 fonts from old installations
TYPE1DIR=/usr/share/fonts/type1/mathematica
if [ -d $TYPE1DIR ]; then
  echo "Purging old Type1 directory."
  rm -rf $TYPE1DIR
fi

# start installation
   if [ $do_settings -eq 1 ]; then
       unzip $FILE 1>&2
       rm $FILE

#       mkdir -p $FONTDIR $TYPE1DIR  ## this will left directories after removal
       rm -f $FONTDIR/*.ttf
       chmod 644 ./TrueType/*.ttf
       mv ./TrueType/*.ttf $FONTDIR
       cd /
       rm -rf $SCRATCHDIR
       if [ -z "$QUIETMODE" ] ; then
	   if $SHA512SUM -c --status $PDIR/sha512-ttf; then
	       fl_success=1
	   fi

	   if [ $fl_success -eq 1 ]; then
           echo "All fonts are downloaded and installed successfully."
	   echo ""
	   else
           echo "Installation seems failed by unknown reason."
	   echo ""
	   fi
       fi
   else
   rm -rf $SCRATCHDIR $HOME
   fi # end of "do_settings=1"
fi # end of "do_download=1"
fi # end of if configure


# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.



exit 0
