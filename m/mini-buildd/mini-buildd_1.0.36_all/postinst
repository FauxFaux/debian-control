#!/bin/sh -e

. /usr/share/debconf/confmodule

DEFAULT_FILE="/etc/default/mini-buildd"

# Generate default file if it does not exist (it usually should, as we ship it)
if [ ! -e "${DEFAULT_FILE}" ]; then
	touch "${DEFAULT_FILE}"
fi

_update_file()
{
	local db_id="${1}"
	local sh_id="${2}"
	local default="${3}"

	# Get value (RET) from db
	db_get ${db_id}

	# Replace existing line or add new
	if grep -Eq "^ *${sh_id}=" "${DEFAULT_FILE}"; then
		# Existing config; remove the config line if the new value is the default.
		if [ "${default}" = "${RET}" ]; then
			sed -i "/^ *${sh_id}=.*/d" "${DEFAULT_FILE}"
		else
			sed -i "s|^ *${sh_id}=.*|${sh_id}=\"${RET}\"|" "${DEFAULT_FILE}"
		fi
	else
		# New config line; only do it if this is not the default, so
		# we don't get unnecessarily changed default file.
		if [ "${default}" != "${RET}" ]; then
			printf "${sh_id}='${RET}'\n" >>"${DEFAULT_FILE}"
		fi
	fi
}

# Default values values must by synced in *.postinst, *.templates and *.init.
_update_file mini-buildd/options MINI_BUILDD_OPTIONS "--verbose"

#
# Handle mini-buildd user
#
db_get mini-buildd/home
MINI_BUILDD_HOME="${RET}"
# Some code may actually choke (and break builds) if the passwd geco field is empty, so we set it
MINI_BUILDD_FULL_NAME="Custom Debian buildd"
if ! getent passwd mini-buildd >/dev/null; then
	# Fresh install: Add a new system user/group: mini-buildd/mini-buildd
	adduser --system --group --shell /bin/bash --home "${MINI_BUILDD_HOME}" --gecos "${MINI_BUILDD_FULL_NAME}" mini-buildd
else
	# Existing user

	# Compat (<0.9.6): Always fix old-style user/group: mini-buildd/sbuild to mini-buildd/mini-buildd
	addgroup --system mini-buildd
	usermod --gid=mini-buildd mini-buildd

	# Fix HOME if needed
	usermod --home="${MINI_BUILDD_HOME}" --comment="${MINI_BUILDD_FULL_NAME}" --move-home mini-buildd
fi

# Always (re-)add to group sbuild
addgroup mini-buildd sbuild

# Always (re-)write mini-buildd's fstab to use with schroot.
# For sbuild to work the way we call it, we need
# ~/var/spool/        : Build log, ...
# ~/var/chroots-libdir: For optional %LIBDIR% support (ccache, ...).
FSTAB_FILE="/etc/schroot/mini-buildd/fstab"
cat <<EOF >${FSTAB_FILE}
# Generated by ${0} on $(date).
# Please don't edit this file; you may customize fstab-generic if needed.
#
${MINI_BUILDD_HOME}/var/spool          ${MINI_BUILDD_HOME}/var/spool          none  rw,bind 0  0
${MINI_BUILDD_HOME}/var/chroots-libdir ${MINI_BUILDD_HOME}/var/chroots-libdir none  rw,bind 0  0
#
EOF
cat ${FSTAB_FILE}-generic >>${FSTAB_FILE}

#
# Handle password
#
db_get mini-buildd/admin_password
MINI_BUILDD_ADMIN_PASSWORD="${RET}"
if [ -n "${MINI_BUILDD_ADMIN_PASSWORD}" ]; then
	printf "Setting admin password..."
	su mini-buildd -c "/usr/sbin/mini-buildd --set-admin-password='${MINI_BUILDD_ADMIN_PASSWORD}'"
	db_set mini-buildd/admin_password ""
	printf "done.\n"
fi

# Automatically added by dh_systemd_enable/11.3.2
if [ "$1" = "configure" ] || [ "$1" = "abort-upgrade" ] || [ "$1" = "abort-deconfigure" ] || [ "$1" = "abort-remove" ] ; then
	# This will only remove masks created by d-s-h on package removal.
	deb-systemd-helper unmask 'mini-buildd.service' >/dev/null || true

	# was-enabled defaults to true, so new installations run enable.
	if deb-systemd-helper --quiet was-enabled 'mini-buildd.service'; then
		# Enables the unit on first installation, creates new
		# symlinks on upgrades if the unit file has changed.
		deb-systemd-helper enable 'mini-buildd.service' >/dev/null || true
	else
		# Update the statefile to add new symlinks (if any), which need to be
		# cleaned up on purge. Also remove old symlinks.
		deb-systemd-helper update-state 'mini-buildd.service' >/dev/null || true
	fi
fi
# End automatically added section
# Automatically added by dh_installdeb/11.3.2
dpkg-maintscript-helper rm_conffile /etc/bash_completion.d/mini-buildd.bash-completion -- "$@"
# End automatically added section
# Automatically added by dh_installinit/11.3.2
if [ "$1" = "configure" ] || [ "$1" = "abort-upgrade" ] || [ "$1" = "abort-deconfigure" ] || [ "$1" = "abort-remove" ] ; then
	if [ -x "/etc/init.d/mini-buildd" ]; then
		update-rc.d mini-buildd defaults >/dev/null
		if [ -n "$2" ]; then
			_dh_action=restart
		else
			_dh_action=start
		fi
		invoke-rc.d mini-buildd $_dh_action || exit 1
	fi
fi
# End automatically added section


exit 0
