#!/bin/sh
# postinst script for opendnssec-common

set -e

set_perms() {
    if ! dpkg-statoverride --list "$4" >/dev/null; then
        dpkg-statoverride --quiet --update --add "$@"
    fi
}

unset_perms() {
    dpkg-statoverride --quiet --remove "$1" || true
}

case "$1" in
    configure)

	if dpkg --compare-versions "$2" le "1.3.6-1"; then
	    for conf in zonefetch.xml; do
		unset_perms /etc/opendnssec/$conf
                # and finally clear it out from the ucf database
		[ -f /etc/opendnssec/$conf.dpkg-del ] && \
		    rm -f /etc/opendnssec/$conf.dpkg-del
		ucf --purge /etc/opendnssec/$conf
		ucfr --purge opendnssec /etc/opendnssec/$conf
	    done
	fi

	if ! getent passwd opendnssec > /dev/null; then
            adduser --quiet --system --group --no-create-home --home /var/lib/opendnssec opendnssec
	fi

	set_perms root opendnssec 0750 /etc/opendnssec
	set_perms root opendnssec 0750 /var/lib/opendnssec

	for dir in tmp signconf unsigned signed db signer enforcer; do
	    set_perms opendnssec opendnssec 0755 /var/lib/opendnssec/$dir
	done

	for conf in addns.xml conf.xml kasp.xml zonelist.xml; do
	    ucf /usr/share/opendnssec/$conf /etc/opendnssec/$conf
	    ucfr opendnssec /etc/opendnssec/$conf
	    set_perms root opendnssec 0640 /etc/opendnssec/$conf
	done

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac



exit 0
