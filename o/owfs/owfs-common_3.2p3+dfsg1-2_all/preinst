#!/bin/sh
set -e

# summary of how this script can be called:
#        * <new-preinst> `install'
#        * <new-preinst> `install' <old-version>
#        * <new-preinst> `upgrade' <old-version>
#        * <old-preinst> `abort-upgrade' <new-version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

last=
for i in $(ls /etc/modprobe.d/libow-*-*.conf 2>/dev/null)
do
  if test "$(md5sum < "$i")" \
	!= "9c0ce25c8de4426c2dff7738ccf67f96  -"; then
    # a file has been modified. We will keep it.
    last="$i".dpkg-old
  fi
  # removing old config files for previous ow libraries
  # (they will be really removed when the package will be purged)
  mv "$i" "$i".dpkg-old
done

if [ -n "$last" ]; then
  # We try to keep user modifications
  cp -a "$last" /etc/modprobe.d/libow-common.conf
fi

case "$1" in
    install|upgrade)
	if ! getent group Debian-ow >/dev/null; then
	    GROUP="--group"
	else
	    GROUP="--ingroup Debian-ow"
	fi
	if ! getent passwd Debian-ow >/dev/null; then
	    adduser --quiet \
		--system \
		--force-badname \
		$GROUP \
		--quiet \
		--disabled-login \
		--disabled-password \
		--no-create-home \
		--home /var/lib/owfs \
		--gecos "Debian OWFS system account" \
		Debian-ow

	fi
	;;
esac


