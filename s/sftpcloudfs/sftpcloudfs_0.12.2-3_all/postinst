#!/bin/sh

set -e

if [ "${1}" = "configure" ] ; then
	if ! getent group sftpcloudfs > /dev/null 2>&1 ; then
		addgroup --system sftpcloudfs >/dev/null
	fi
	if ! getent passwd sftpcloudfs > /dev/null 2>&1 ; then
		adduser --system --home /var/log/sftpcloudfs --ingroup sftpcloudfs --no-create-home --shell /bin/false sftpcloudfs > /dev/null 2>&1
	fi

	# RAS key file directory
	if [ ! -e /etc/sftpcloudfs ] ; then
		mkdir -m 0700 -p /etc/sftpcloudfs
	fi
	if [ ! -e /etc/sftpcloudfs/sftpcloudfs.key ] ; then
		ssh-keygen -f /etc/sftpcloudfs/sftpcloudfs.key -N '' -C ''
	fi
	if [ ! -e /etc/sftpcloudfs/sftpcloudfs.conf ] ; then
		install -D -m 0640 -g sftpcloudfs -o sftpcloudfs /usr/share/sftpcloudfs/sftpcloudfs.conf /etc/sftpcloudfs/sftpcloudfs.conf
		MY_GID=`id -g sftpcloudfs`
		MY_UID=`id -u sftpcloudfs`
		sed -i -e "s#^[ \t]*uid[ \t]*=.*#uid = ${MY_UID}#" /etc/sftpcloudfs/sftpcloudfs.conf
		sed -i -e "s#^[ \t]*gid[ \t]*=.*#gid = ${MY_GID}#" /etc/sftpcloudfs/sftpcloudfs.conf
	fi
	chown -R sftpcloudfs:sftpcloudfs /etc/sftpcloudfs

	# log directory
	mkdir -m 0700 -p /var/log/sftpcloudfs
	touch /var/log/sftpcloudfs/sftpcloudfs.log
	chmod 0640 /var/log/sftpcloudfs/sftpcloudfs.log
	chown -R sftpcloudfs:sftpcloudfs /var/log/sftpcloudfs

	# pid file directory
	mkdir -m 0700 -p /var/run/sftpcloudfs
	chown -R sftpcloudfs:sftpcloudfs /var/run/sftpcloudfs

	# Debconf for the auth-url
	. /usr/share/debconf/confmodule
	db_get sftpcloudfs/auth-url
	if [ -n "${RET}" ] ; then
		sed -i -e "s#^[ \t]*auth-url[ \t]*=.*#auth-url = ${RET}#" /etc/sftpcloudfs/sftpcloudfs.conf
	fi
	db_stop
fi


# Automatically added by dh_python2:
if which pycompile >/dev/null 2>&1; then
	pycompile -p sftpcloudfs 
fi

# End automatically added section
# Automatically added by dh_installinit/11.1.3
if [ "$1" = "configure" ] || [ "$1" = "abort-upgrade" ] || [ "$1" = "abort-deconfigure" ] || [ "$1" = "abort-remove" ] ; then
	if [ -x "/etc/init.d/sftpcloudfs" ]; then
		update-rc.d sftpcloudfs defaults >/dev/null
		invoke-rc.d sftpcloudfs start || true
	fi
fi
# End automatically added section


exit 0
