#!/bin/sh

set -e

if [ -f /usr/share/debconf/confmodule ]; then
    . /usr/share/debconf/confmodule
fi

if [ -f /usr/share/dbconfig-common/dpkg/postrm ]; then
    . /usr/share/dbconfig-common/dpkg/postrm
    dbc_go sympa $@
fi

# Remove conffiles used by apache2 < 2.4
if which dpkg-maintscript-helper >/dev/null && dpkg-maintscript-helper supports rm_conffile ; then
    for i in apache apache-soap httpd.conf-cgi httpd.conf-fcgi ; do
        dpkg-maintscript-helper rm_conffile "/etc/sympa/${i}" \
            "6.1.17~dfsg-1~" -- "$@"
    done
fi

if [ "$1" = "remove" ]; then
    if [ -e /usr/share/apache2/apache2-maintscript-helper ] ; then
        # Apache2 >= 2.4
        . /usr/share/apache2/apache2-maintscript-helper
        apache2_invoke disconf sympa.conf
        apache2_invoke disconf sympa-soap.conf
    fi
fi

if [ "$1" = "purge" ]; then
    db_input high wwsympa/remove_spool || true
    db_go
    db_get wwsympa/remove_spool
    remove_archives="$RET"

    if [ "$remove_archives" = "true" ]; then
        echo "Removing archives and spool subdirectories as requested..."
        rm -rf /var/lib/sympa/wwsarchive 2>/dev/null || true
        rm -rf /var/spool/sympa/wws* 2>/dev/null || true
    fi

    # Delete the log files if purging, remove aliases too.
    rm -f /var/log/sympa.log*

    # Remove static content directory
    if [ -d /var/lib/sympa/static_content ]; then
        rm -r /var/lib/sympa/static_content
    fi

    rm -f /etc/sympa/cookie 2>/dev/null || true
    rm -f /etc/sympa/cookies.history

    # Remove configuration files
    rm -f /etc/sympa/data_structure.version
    rm -f /etc/sympa/data_structure.version.debian-old
    rm -f /etc/sympa/sympa/sympa.conf
    rm -f /etc/sympa/wwsympa.conf
    find /etc/sympa -iname '*.conf.bin' -delete
    # Backup files generated by Sympa while migrating from 6.1 to 6.2
    find /etc/sympa -regextype egrep -regex \
        '^.*\.upgrade[0-9]{2}\.\w{3}\.[0-9]{4}-[0-9]{2}\.[0-9]{2}\.[0-9]{2}$' \
        -delete

    # Remove sympa aliases
    rm -f /etc/mail/sympa/aliases /etc/mail/sympa/aliases.db
    newaliases || true

    # Try to remove if empty
    rmdir /etc/sympa 2>/dev/null || true

    db_input high sympa/remove_spool || true
    db_go
    db_get sympa/remove_spool
    remove_spool="$RET"

    if [ "$remove_spool" = "true" ]; then
        echo "Removing lists data and spool directory as requested..."
        rm -rf /var/lib/sympa 2>/dev/null || true
        rm -rf /var/spool/sympa 2>/dev/null || true
    fi
fi

# Automatically added by dh_installdeb/10.7.2
dpkg-maintscript-helper rm_conffile /etc/sympa/sympa.conf-smime.in "6.2.16~dfsg-4~" -- "$@"
# End automatically added section
# Automatically added by dh_installdeb/10.7.2
dpkg-maintscript-helper rm_conffile /etc/sympa/sympa/sympa.conf "6.2.16~dfsg-2~" -- "$@"
# End automatically added section
# Automatically added by dh_systemd_start/10.7.2
if [ -d /run/systemd/system ]; then
	systemctl --system daemon-reload >/dev/null || true
fi
# End automatically added section
# Automatically added by dh_installinit/10.7.2
if [ "$1" = "purge" ] ; then
	update-rc.d sympa remove >/dev/null
fi


# In case this system is running systemd, we make systemd reload the unit files
# to pick up changes.
if [ -d /run/systemd/system ] ; then
	systemctl --system daemon-reload >/dev/null || true
fi
# End automatically added section
# Automatically added by dh_systemd_enable/10.7.2
if [ "$1" = "remove" ]; then
	if [ -x "/usr/bin/deb-systemd-helper" ]; then
		deb-systemd-helper mask sympa.service >/dev/null
	fi
fi

if [ "$1" = "purge" ]; then
	if [ -x "/usr/bin/deb-systemd-helper" ]; then
		deb-systemd-helper purge sympa.service >/dev/null
		deb-systemd-helper unmask sympa.service >/dev/null
	fi
fi
# End automatically added section
# Automatically added by dh_installdebconf/10.7.2
if [ "$1" = purge ] && [ -e /usr/share/debconf/confmodule ]; then
	. /usr/share/debconf/confmodule
	db_purge
fi
# End automatically added section


exit 0
