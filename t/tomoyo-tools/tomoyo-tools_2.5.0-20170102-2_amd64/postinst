#!/bin/sh

CONFDIR="/etc/tomoyo/tool"
CONFFILES="audit.conf editpolic.conf notifyd.conf patternize.conf stat.conf"
GRUBCONF="/etc/default/grub"
FLAG="security=tomoyo"

set -e

pathfind() {
    OLDIFS="$IFS"
    IFS=:
    for p in $PATH; do
        if [ -x "$p/$*" ]; then
            IFS="$OLDIFS"
            return 0
        fi
    done
    IFS="$OLDIFS"
    return 1
}

case "$1" in
    install|configure)
	if [ -d $CONFDIR ]; then cd $CONFDIR && \
        for file in $CONFFILES
        do
          if [ -f $file ]; then
            echo "check $file..."
          else
            echo "Policy file does NOT exist. Now initialised..."
            /usr/lib/tomoyo/init_policy
	    break
          fi
        done
	fi

	# enable tomoyo
        . /usr/share/debconf/confmodule
        db_version 2.0
        db_get tomoyo-tools/grub
        db_stop

	if [ -f $GRUBCONF ] && `pathfind update-grub` && ! grep -q "^GRUB_CMDLINE_LINUX=.*$FLAG.*" $GRUBCONF; then
	    sed -e 's/^\(GRUB_CMDLINE_LINUX="[^"]*\)"$/\1 '$FLAG'"/' -e 's/=" /="/' -i $GRUBCONF && update-grub
	else
	    echo "no grub settings (it may have other bootloader, quit...)"
	fi
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.



exit 0
