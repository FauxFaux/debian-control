#!/bin/sh

set -e

CONFDIR="/etc/tomoyo"
CONFFILES="domain_policy.conf exception_policy.conf manager.conf profile.conf meminfo.conf stat.conf"
GRUBCONF="/etc/default/grub"
FLAG="security=tomoyo"

pathfind() {
    OLDIFS="$IFS"
    IFS=:
    for p in $PATH; do
        if [ -x "$p/$*" ]; then
            IFS="$OLDIFS"
            return 0
        fi
    done
    IFS="$OLDIFS"
    return 1
}

remove_tomoyo_from_grub() {
    if [ -f /etc/default/grub ] && `pathfind update-grub`; then
      sed -e /^GRUB_CMDLINE_LINUX/s/$FLAG// -e 's/=" /="/' -e 's/ "$/"/' \
          -i $GRUBCONF && update-grub
    fi
}

case "$1" in
    upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
    ;;

    remove)
    remove_tomoyo_from_grub
    ;;

    purge)
    for conffile in $CONFFILES
    do
      if [ -f $CONFDIR/$conffile ]; then
        rm $CONFDIR/$conffile
      fi
    done

    rm -rf /etc/tomoyo/policy || true

    remove_tomoyo_from_grub
    ;;

   *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

# Automatically added by dh_installdebconf/11.3.2
if [ "$1" = purge ] && [ -e /usr/share/debconf/confmodule ]; then
	. /usr/share/debconf/confmodule
	db_purge
fi
# End automatically added section


exit 0
