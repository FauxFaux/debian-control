#!/bin/sh

set -e

TRYTON_USER="tryton"
TRYTON_OLDCONFFILE="/etc/trytond.conf"
TRYTON_CONFDIR="/etc/tryton"
TRYTON_CONFFILE="${TRYTON_CONFDIR}/trytond.conf"
TRYTON_LOGCONFFILE="${TRYTON_CONFDIR}/trytond_log.conf"
TRYTON_CONFFILEPRE34="${TRYTON_CONFDIR}/trytond.conf.pre34"
TRYTON_LOGDIR="/var/log/tryton"
TRYTON_HOMEDIR="/var/lib/tryton"

# POSIX-compliant shell function to check for the existence of a command
# s. developers-reference 6.4
pathfind() {
    OLDIFS="$IFS"
    IFS=:
    for p in $PATH; do
        if [ -x "$p/$*" ]; then
            IFS="$OLDIFS"
            return 0
        fi
    done
    IFS="$OLDIFS"
    return 1
}

case "${1}" in
	purge)
		# Removing evtl. dpkg-statoverrides
		for _ITEM in "${TRYTON_OLDCONFFILE}" "${TRYTON_CONFFILE}" "${TRYTON_LOGCONFFILE}" "${TRYTON_HOMEDIR}" "${TRYTON_LOGDIR}"
		do
			dpkg-statoverride --force --remove "${_ITEM}" > /dev/null 2>&1 || true
		done

		# Removing system user
		if pathfind deluser;
		then
			deluser --quiet --system "${TRYTON_USER}"
		fi

		# Removing log directory
		rmdir --ignore-fail-on-non-empty "${TRYTON_LOGDIR}" > /dev/null 2>&1 || true

		# Removing (potentially) leftover old configuration backup
		rm -f "${TRYTON_CONFFILEPRE34}"

		# Removing (potentially) empty directories
		for _ITEM in "${TRYTON_CONFDIR}" "${TRYTON_LOGDIR}" "${TRYTON_HOMEDIR}"
		do
			rmdir --ignore-fail-on-non-empty "${_ITEM}" > /dev/null 2>&1 || true
		done
		;;

	remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)

		;;

	*)
		echo "postrm called with unknown argument \`${1}'" >&2
		exit 1
		;;
esac

# Automatically added by dh_installinit/12
if [ "$1" = "purge" ] ; then
	update-rc.d tryton-server-worker remove >/dev/null
fi
# End automatically added section
# Automatically added by dh_installinit/12
if [ "$1" = "purge" ] ; then
	update-rc.d tryton-server-cron remove >/dev/null
fi
# End automatically added section
# Automatically added by dh_installinit/12
if [ "$1" = "purge" ] ; then
	update-rc.d tryton-server remove >/dev/null
fi
# End automatically added section
# Automatically added by dh_installsystemd/12
if [ "$1" = "remove" ]; then
	if [ -x "/usr/bin/deb-systemd-helper" ]; then
		deb-systemd-helper mask 'tryton-server.service' >/dev/null || true
	fi
fi

if [ "$1" = "purge" ]; then
	if [ -x "/usr/bin/deb-systemd-helper" ]; then
		deb-systemd-helper purge 'tryton-server.service' >/dev/null || true
		deb-systemd-helper unmask 'tryton-server.service' >/dev/null || true
	fi
fi
# End automatically added section
# Automatically added by dh_systemd_enable/12
if [ "$1" = "remove" ]; then
	if [ -x "/usr/bin/deb-systemd-helper" ]; then
		deb-systemd-helper mask 'tryton-server.service' >/dev/null || true
	fi
fi

if [ "$1" = "purge" ]; then
	if [ -x "/usr/bin/deb-systemd-helper" ]; then
		deb-systemd-helper purge 'tryton-server.service' >/dev/null || true
		deb-systemd-helper unmask 'tryton-server.service' >/dev/null || true
	fi
fi
# End automatically added section


exit 0
