#!/bin/sh -e

can_remove() {
  dpkgconf='/etc/dpkg/dpkg.cfg.d/usrmerge'

  [ -e "$dpkgconf" ] || return 0

  local pkgs="$(awk '/^# [^ ]+$/ { print $2 }' $dpkgconf)"
  [ "$pkgs" ] || return 0

  local installed="$(dpkg-query --showformat='${Package}\n' --show $pkgs 2> /dev/null)"

  if [ "$installed" ]; then
    cat <<END

Some installed packages have not yet been converted to support usrmove:
$installed

If you remove this package then updating them will fail.
Please delete $dpkgconf to confirm that you understand this.

END
    exit 1
  fi
}

case "$1" in
    remove)
    # check if the package can be safely removed
    can_remove
    ;;
esac



