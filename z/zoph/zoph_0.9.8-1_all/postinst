#!/bin/sh
# postinst script for zoph
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package

inifile="/etc/zoph.ini"
#db_pass=`cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 10 | head -n 1`

makeini() {
 if [ -f "$inifile" ]; then
     echo "$inifile already exists"
     # Not an error
#     exit 1 
  else
#     db_pass=`cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 10 | head -n 1`
     db_pass=`dbconfig-generate-include -f sh -p /etc/dbconfig-common/zoph.conf | tail -1 | cut -d "'" -f 2`
#     echo "db_pass is $db_pass"
     {  echo '[zoph]'
        echo 'db_host = "localhost"'
        echo 'db_name = "zoph"'
        echo 'db_user = "zoph_rw"'
        echo "db_pass = \"${db_pass}\""
        echo 'db_prefix = "zoph_"'
        echo 'php_location = "/usr/share/zoph/www/php"'
      } > $inifile
      chown www-data:zoph $inifile
      chmod 440 $inifile
   fi
}


case "$1" in
    configure)
      . /usr/share/debconf/confmodule


  addgroup --system zoph

if [ -f /usr/share/dbconfig-common/dpkg/postinst ]; then
   . /usr/share/dbconfig-common/dpkg/postinst
#   dbc_debug=1
   dbc_dbpass=$db_pass
   dbc_mysql_createdb_encoding="UTF8"
   dbc_go zoph "$@"
   fi

       makeini 

# Fix permissions
  chown www-data:zoph /var/lib/zoph
  chmod 774 /var/lib/zoph
  chmod g+s /var/lib/zoph

# Configure the web service
   ln -s /etc/zoph/apache.conf /etc/apache2/conf-available/zoph.conf


#   for automatic installation
   a2enconf zoph

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.



exit 0
